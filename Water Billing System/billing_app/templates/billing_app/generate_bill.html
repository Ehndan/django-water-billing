{% extends 'billing_app/dashboard.html' %}
{% block content %}
  {% if messages %}
    {% for message in messages %}
      <script>window.onload=()=>alert("{{ message|escapejs }}");</script>
    {% endfor %}
  {% endif %}

  <h2>Generate Bill</h2>
  <form method="POST" action="{% url 'generate_bill' %}">
    {% csrf_token %}

    <label for="consumer_name">Consumer:</label>
    <input list="consumer-list" name="consumer_name" id="consumer_name"
           value="{{ initial_consumer }}" required>
    <datalist id="consumer-list">
      {% for c in consumers %}<option value="{{ c.name }}">{% endfor %}
    </datalist><br><br>

    <label for="billing_period">Billing Period:</label>
    <input type="month" name="billing_period" id="billing_period"
           value="{{ initial_period }}" required><br><br>

    <label for="meter_number">Meter Number:</label>
    <input type="text" name="meter_number" id="meter_number" required><br><br>

    <label for="previous_reading">Previous Reading (m³):</label>
    <input type="text" id="previous_reading" readonly><br><br>

    <label for="current_reading">Current Reading (m³):</label>
    <input type="number" step="0.01" name="current_reading" id="current_reading" required><br><br>

    <label for="due_date">Due Date:</label>
    <input type="date" name="due_date" id="due_date" required><br><br>

    <button type="submit">Generate</button>
  </form>

  <br>
  
  <a href="{% url 'dashboard' %}">
    <button>Back</button>
  </a>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const consumerInput = document.getElementById('consumer_name');
      const periodInput   = document.getElementById('billing_period');
      const prevField     = document.getElementById('previous_reading');
      const currentInput  = document.getElementById('current_reading');
      const meterInput    = document.getElementById('meter_number');
      const dueInput      = document.getElementById('due_date');
      const form          = document.querySelector('form');
  
      function fetchPrev() {
        const name = consumerInput.value.trim();
        const period = periodInput.value;
        if (!name || !period) { prevField.value = ''; return; }
  
        fetch(`{% url 'get_prev_reading' %}` +
              `?consumer_name=${encodeURIComponent(name)}` +
              `&billing_period=${encodeURIComponent(period)}`,
          { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
          .then(r => r.json())
          .then(d => prevField.value = parseFloat(d.previous_reading).toFixed(2))
          .catch(_ => prevField.value = '0.00');
      }
  
      consumerInput.addEventListener('input', fetchPrev);
      consumerInput.addEventListener('change', fetchPrev);
      periodInput.addEventListener('input', fetchPrev);
      periodInput.addEventListener('change', fetchPrev);
  
      if (consumerInput.value && periodInput.value) {
        fetchPrev();
      }
  
      dueInput.addEventListener('change', function() {
        if (this.value < periodInput.value) {
          alert('Due date cannot be earlier than the billing period.');
          this.value = '';
        }
      });
  
      form.addEventListener('submit', function(e) {
        const due = dueInput.value;
        const period = periodInput.value;
        const current = parseFloat(currentInput.value);
        const previous = parseFloat(prevField.value);
        const meter = meterInput.value;
  
        if (!currentInput.value || !meter) {
          alert('Please input the current reading and meter number.');
          e.preventDefault();
          return;
        }
  
        if (due < period) {
          alert('Due date cannot be earlier than the billing period.');
          e.preventDefault();
          return;
        }
  
        if (!isNaN(current) && !isNaN(previous) && current < previous) {
          alert('Current reading cannot be less than previous reading.');
          e.preventDefault();
        }
      });
    });
  </script>
  
{% endblock %}
